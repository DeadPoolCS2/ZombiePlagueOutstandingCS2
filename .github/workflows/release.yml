name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Restore dependencies
        run: dotnet restore src/HanZombiePlagueS2/HanZombiePlagueS2.csproj

      - name: Publish plugin
        run: |
          dotnet publish src/HanZombiePlagueS2/HanZombiePlagueS2.csproj \
            --configuration Release \
            --output ./publish/HanZombiePlagueS2

      - name: Package release artifact
        run: |
          OUTDIR=release-package
          PLUGIN=HanZombiePlagueS2

          mkdir -p "$OUTDIR/addons/swiftlys2/plugins/$PLUGIN"
          mkdir -p "$OUTDIR/addons/swiftlys2/configs/plugins/$PLUGIN"

          # Plugin DLL and its dependencies
          cp publish/$PLUGIN/$PLUGIN.dll "$OUTDIR/addons/swiftlys2/plugins/$PLUGIN/"
          if [ -d "publish/$PLUGIN/resources" ]; then
            cp -r publish/$PLUGIN/resources "$OUTDIR/addons/swiftlys2/plugins/$PLUGIN/"
          fi

          # Configs
          cp -r configs/plugins/$PLUGIN/. "$OUTDIR/addons/swiftlys2/configs/plugins/$PLUGIN/"

          # Package
          cd "$OUTDIR"
          zip -r "../$PLUGIN.zip" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: HanZombiePlagueS2
          path: HanZombiePlagueS2.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: HanZombiePlagueS2.zip
